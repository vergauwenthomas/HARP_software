library(stringi)
library(harp)


read_custom_observations <- function(obsfolder) {
  " Read all observation files, generated by titan, into one tibble dataframe. Only the 'ok' observations are returned.
      All files in the obsfolder (=path to the folder containing the data .txt files) are read. "
  
  
  # get all files in folder and create one data frame
  obs_files = file.path(obsfolder, list.files(obsfolder))
  obs = data.frame()
  for (obs_file in obs_files){
    #read data
    sub_obs = read.csv(obs_file, sep=';')
    #get datetime 
    dt_char = stri_sub(obs_file, -15, -5) #this should be something like "20200801T05"
    mydate = strptime(dt_char,format='%Y%m%dT%H') #convert to POSIXct
    sub_obs$validdate = mydate
    obs = rbind(obs, sub_obs)
  }
  
  # convert units to K
  obs$value = obs$value + 273.15
  obs$units = 'K'
  
  # convert all names to SID's (integer unique indicator)
  obs$sid <- unclass(obs$station)
  # station_sid_df = obs %>% select(station, sid)

  # rename, set type and reorder columns
  obs = rename(obs, T2m_observed = value)
  obs = rename(obs, SID = sid)
  
  # subset all ok observations
  ok_obs <- obs  %>% filter(quality_flag == 'ok')
  
  #rearange columns
  cols_to_keep = c('validdate', 'SID', 'lat', 'lon', 'elev', 'T2m_observed', 'units', 'station')
  ok_obs <- ok_obs[, cols_to_keep]
  
  #to tibble
  ok_obs = as_tibble(ok_obs)
  
  return(ok_obs)
}








plot_at_station_level <- function(fcst, observations, stationname, add_observations = TRUE, dateresolution = "1h"){
  
  
  
  startdate = bind_fcst(fcst) %>% select(validdate) %>% filter(validdate == min(validdate)) %>% first() %>% first()
  enddate = bind_fcst(fcst) %>% select(validdate) %>% filter(validdate == max(validdate)) %>% first() %>% first()
  
  
  specific_sid = filter(observations, station  == stationname) %>% select(SID) %>% first() %>% first()
  
  fcst_at_station = bind_fcst(fcst) %>% filter(SID == specific_sid) %>% mutate(validdate = unix2datetime(validdate))
  
  
  
  
  if (isTRUE(add_observations)) {
    cat('Plot with observations ...')
    fcst_at_station %>%
      ggplot(aes(validdate, forecast, colour = mname)) +
      geom_line() +
      geom_point(aes(y = T2m_observed, shape = "Observation"), colour = "blue") +
      scale_shape_manual(values = 21) +
      facet_wrap(vars(fcst_cycle), ncol = 1) +
      scale_x_datetime(
        breaks = lubridate::ymd_hm(seq_dates(as.character(startdate,'%Y%m%d%H'),
                                             as.character(enddate,'%Y%m%d%H'),
                                             dateresolution))
      ) + 
      labs(
        x      = "Date-time",
        y      = bquote("T2m [K]"),
        colour = "",
        title  = paste0("Forecast T2m at ", stationname),
        shape  = ""
      ) +
      theme_bw() +
      theme(legend.position = "bottom")
    
    
  }else{
    
    fcst_at_station %>%
      ggplot(aes(validdate, forecast, colour = fcst_cycle)) +
      geom_line() +
      facet_wrap(vars(mname), ncol = 1) +
      scale_x_datetime(
        breaks = lubridate::ymd_hm(seq_dates(as.character(startdate,'%Y%m%d%H'),
                                             as.character(enddate,'%Y%m%d%H'),
                                             dateresolution))
      ) + 
      labs(
        x      = "Date-time",
        y      = bquote("T2m [K]"),
        colour = "Forecast cycle",
        title  = paste0("Forecast T2m at ", stationname)
      ) +
      theme_bw() +
      theme(legend.position = "bottom")
  }
}


plot_basic_scores <- function(fcst){
  " A function to plot the basic scores for a forcast. Make shure the observations are added to the forcast so a column T2m_observed is in the forecast"
  
  scores = det_verify(fcst, parameter = T2m_observed)$det_summary_scores
  print(scores)
  
  
  
  scores %>% pivot_longer(cols = c('rmse', 'mae', 'bias', 'stde')) %>% select(-num_cases) %>%
    ggplot(aes(leadtime, value, colour = name)) +
    geom_line() +
    facet_wrap(vars(mname), ncol = 1) +
    labs(
      x      = "leadtime",
      y      = bquote("score-specific"),
      colour = "Scores",
      title  = paste0("Basic scores")
    ) +
    theme_bw() +
    theme(legend.position = "bottom")
}
